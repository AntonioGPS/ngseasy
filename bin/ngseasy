#!/bin/bash -e -x

################################################################
# Program: ngseasy
# Version 1.0 
# Author: Stephen Newhouse (stephen.j.newhouse@gmail.com)
#################################################################

## Set version and run date
#
NGSEASYVERSION="1.0"
RUNDATE=`date +"%d%m%y"`

## test if docker is intsalled and exit if not
#
command -v docker >/dev/null 2>&1 || { echo -e "Docker not installed.\nAborting." >&2; exit 1; }
DOCKERVERSION=`docker version`
DOCKERINFO=`docker info`
echo -e "\n"[`date`]":[NGSEASY:${NGSEASYVERSION}]:"[Log:START]":[${USER}]:[`uname -a`]" 
echo -e "\n---\nDocker Version\n---\n${DOCKERVERSION}\n---\n"Docker Info"\n---\n${DOCKERINFO}\n---\n"
echo -e [`date`]":[NGSEASY:${NGSEASYVERSION}]:"[Log:START]":[${USER}]:[`uname -a`]"  >> ${HOME}/ngseasy_logs/${USER}.${RUNDATE}.NGSEASY.log
echo -e "\n---\nDocker Version\n---\n${DOCKERVERSION}\n---\n"Docker Info"\n---\n${DOCKERINFO}\n---\n" >> ${HOME}/ngseasy_logs/${USER}.${RUNDATE}.NGSEASY.log

## global logging fuction
#
function logger_ngseasy() {
 message=${1}
 mylogfile=${2}
 echo -e [`date`]":[NGSEASY:${NGSEASYVERSION}]:"${message}":[${USER}]:[`uname -a`]" >> ${mylogfile}.log;
 echo -e [`date`]":[NGSEASY:${NGSEASYVERSION}]:"${message}":[${USER}]:[`uname -a`]"
}

## global usage
#
function usage_ngseasy() {
    echo "
Program: ngseasy
Version 1.0
Author: Stephen Newhouse (stephen.j.newhouse@gmail.com)

usage:   ngseasy_full -c <config_file> -d <project_directory>

options:  -c  configuration file
          -d  project directory
          -h  show this message 
"
}

## check and make ~/ngseasy_logs if needed
#
if [[ ! -e  ${HOME}/ngseasy_logs ]]
then
  mkdir ${HOME}/ngseasy_logs
  global_run_logs="${HOME}/ngseasy_logs"
  logger_ngseasy "making ${HOME}/ngseasy_logs" ${HOME}/ngseasy_logs/${RUNDATE}.NGSEASY
else
  logger_ngseasy "${HOME}/ngseasy_logs exists" ${HOME}/ngseasy_logs/${RUNDATE}.NGSEASY
fi

## example config: https://docs.google.com/spreadsheets/d/1VWqmMffkVDnvOtRJGlPqOYzXWnIN_IONXQHDAawaN5Q/edit#gid=0

## default options
make_dirs=0
set_fastq=0

## get options for command line args
while  getopts "hc:d:pf" opt
do

  case ${opt} in

   h)
   usage_ngseasy #print help
   exit 0
   ;;

   c)
   config_tsv=${OPTARG}
   echo "-c = ${config_tsv}"
   ;;

   d)
   project_directory=${OPTARG}
   echo "-d = ${project_directory}"
   ;;

   p)
   make_dirs=${OPTARG}
   echo "-p = ${make_dirs}"
   ;;
   
   f)
   set_fastq=${OPTARG}
   echo "-f = ${set_fastq}"
   ;;
   
   
   esac
done

## Check options passed in.
#
if test -z "$2"
  then
  usage_ngseasy
  exit 1
fi

## check file and directory exist.
if [[ ! -e "${config_tsv}" ]] 
  then
	  usage_ngseasy;
	  echo -e "ERROR : ${config_tsv} does not exist\n"
	  exit 1;
fi

## check exists.
if [[ ! -d "${project_directory}" ]] 
  then
	  usage_ngseasy;
	  echo -e "ERROR :  ${project_directory} does not exist\n"
	  exit 1;
fi


# --- Start NGS Pipeline -------------------------------------------------------- #

##-------------------------------------------------------------------------##
## initiate projects 0-0-1
#

if [[ "${make_dirs}" -eq "1" ]]
then
    echo -e  "[ngseasy]:Calling ngseasy_initiate_project" 
    /bin/bash ngseasy_initiate_project -c ${config_tsv} -d ${project_directory}

else
    echo -e  "[ngseasy]:Assuming ngseasy_initiate_project already run. Project and Sample dirctories exist" 
fi


##-------------------------------------------------------------------------##
## initiate fastq files 0-0-2
# copy or move fastq files to project directories 

if [[ "${set_fastq}" -eq "1" ]]
then
    echo -e  "[ngseasy]:Calling ngseasy_initiate_fastq" 
    /bin/bash ngseasy_initiate_fastq -c ${config_tsv} -d ${project_directory}

else
    echo -e  "[ngseasy]:Assuming ngseasy_initiate_fastq already run. Sample fastq files exist and are in the right directories....ngseasy will check later" 
fi

# --- Start NGS Pipeline -------------------------------------------------------- #

# Read config file
while read -r f1 f2 f3 f4 f5 f6 f7 f8 f9 f10 f11 f12 f13 f14 f15 f16 f17 f18 f19 f20 f21 f22
do

## set varibales  
DATE=`date +"%d%m%y"`
  
PROJECT_ID=$f1
SAMPLE_ID=$f2
FASTQ1=$f3
FASTQ2=$f4
PROJECT_DIR=$f5
DNA_PREP_LIBRARY_ID=$f6
NGS_PLATFORM=$f7
NGS_TYPE=$f8
BAIT=$f9
CAPTURE=$f10
FASTQC=$f11
TRIM=$f12
BSQR=$f13
REALN=$f14
ALIGNER=$f15
VARCALLER=$f16
CNV=$f17
ANNOTATOR=$f18
CLEANUP=$f19
NCPU=$f20
VERSION=$f21
NGSUSER=$f22


# Read config file log
logger_ngseasy "[ngseasy]:Reading [${config_tsv}] " ${HOME}/ngseasy_logs/ngseasy.${POJECT_ID}.${USER}.$(date +"%d%m%y)"

echo -e "
[ngseasy]:Reading [${config_tsv}]\n
[ngseasy]:Reading [${config_tsv}]:PROJECT_ID=[$PROJECT_ID]\n
[ngseasy]:Reading [${config_tsv}]:SAMPLE_ID=[$SAMPLE_ID]\n
[ngseasy]:Reading [${config_tsv}]:FASTQ1=[$FASTQ1]\n
[ngseasy]:Reading [${config_tsv}]:FASTQ2=[$FASTQ2]\n
[ngseasy]:Reading [${config_tsv}]:PROJECT_DIR=[$PROJECT_DIR]\n
[ngseasy]:Reading [${config_tsv}]:DNA_PREP_LIBRARY_ID=[$DNA_PREP_LIBRARY_ID]\n
[ngseasy]:Reading [${config_tsv}]:NGS_PLATFORM=[$NGS_PLATFORM]\n
[ngseasy]:Reading [${config_tsv}]:NGS_TYPE=[$NGS_TYPE]\n
[ngseasy]:Reading [${config_tsv}]:BAIT=[$BAIT]\n
[ngseasy]:Reading [${config_tsv}]:CAPTURE=[$CAPTURE]\n
[ngseasy]:Reading [${config_tsv}]:FASTQC=[$FASTQC]\n
[ngseasy]:Reading [${config_tsv}]:TRIM=[$TRIM]\n
[ngseasy]:Reading [${config_tsv}]:BSQR=[$BSQR]\n
[ngseasy]:Reading [${config_tsv}]:REALN=$[$REALN]\n
[ngseasy]:Reading [${config_tsv}]:ALIGNER=[$ALIGNER]\n
[ngseasy]:Reading [${config_tsv}]:VARCALLER=[$VARCALLER]\n
[ngseasy]:Reading [${config_tsv}]:CNV=[$CNV]\n
[ngseasy]:Reading [${config_tsv}]:ANNOTATOR=[$ANNOTATOR]\n
[ngseasy]:Reading [${config_tsv}]:CLEANUP=[$CLEANUP]\n
[ngseasy]:Reading [${config_tsv}]:NCPU=[$NCPU]\n
[ngseasy]:Reading [${config_tsv}]:VERSION=[$VERSION]\n
[ngseasy]:Reading [${config_tsv}]:NGSUSER=[$NGSUSER]"

logger_ngseasy "[ngseasy]:Reading [${config_tsv}]\n
[ngseasy]:Reading [${config_tsv}]:PROJECT_ID=[$PROJECT_ID]\n
[ngseasy]:Reading [${config_tsv}]:SAMPLE_ID=[$SAMPLE_ID]\n
[ngseasy]:Reading [${config_tsv}]:FASTQ1=[$FASTQ1]\n
[ngseasy]:Reading [${config_tsv}]:FASTQ2=[$FASTQ2]\n
[ngseasy]:Reading [${config_tsv}]:PROJECT_DIR=[$PROJECT_DIR]\n
[ngseasy]:Reading [${config_tsv}]:DNA_PREP_LIBRARY_ID=[$DNA_PREP_LIBRARY_ID]\n
[ngseasy]:Reading [${config_tsv}]:NGS_PLATFORM=[$NGS_PLATFORM]\n
[ngseasy]:Reading [${config_tsv}]:NGS_TYPE=[$NGS_TYPE]\n
[ngseasy]:Reading [${config_tsv}]:BAIT=[$BAIT]\n
[ngseasy]:Reading [${config_tsv}]:CAPTURE=[$CAPTURE]\n
[ngseasy]:Reading [${config_tsv}]:FASTQC=[$FASTQC]\n
[ngseasy]:Reading [${config_tsv}]:TRIM=[$TRIM]\n
[ngseasy]:Reading [${config_tsv}]:BSQR=[$BSQR]\n
[ngseasy]:Reading [${config_tsv}]:REALN=$[$REALN]\n
[ngseasy]:Reading [${config_tsv}]:ALIGNER=[$ALIGNER]\n
[ngseasy]:Reading [${config_tsv}]:VARCALLER=[$VARCALLER]\n
[ngseasy]:Reading [${config_tsv}]:CNV=[$CNV]\n
[ngseasy]:Reading [${config_tsv}]:ANNOTATOR=[$ANNOTATOR]\n
[ngseasy]:Reading [${config_tsv}]:CLEANUP=[$CLEANUP]\n
[ngseasy]:Reading [${config_tsv}]:NCPU=[$NCPU]\n
[ngseasy]:Reading [${config_tsv}]:VERSION=[$VERSION]\n
[ngseasy]:Reading [${config_tsv}]:NGSUSER=[$NGSUSER]" ${HOME}/ngseasy_logs/ngseasy.${POJECT_ID}.${USER}.$(date +"%d%m%y")

##-------------------------------------------------------------------------##
## fastqc
if [[ "${FASTQC}" -eq "qc-fastq" ]]
then
    echo -e  "[ngseasy]:Calling ngseasy_fastqc" 
    logger_ngseasy "[ngseasy]:Calling ngseasy_fastqc" ${HOME}/ngseasy_logs/ngseasy.${POJECT_ID}.${USER}.$(date +"%d%m%y") 

    /bin/bash ngseasy_fastqc -c ${config_tsv} -d ${project_directory}

else
    echo -e  "[ngseasy]:Skipping qc-trimming" 
    logger_ngseasy "[ngseasy]:Reading [${config_tsv}] " ${HOME}/ngseasy_logs/ngseasy.${POJECT_ID}.${USER}.$(date +"%d%m%y") 
fi

##-------------------------------------------------------------------------##
## adapter and read/base quality trimming
if [[ "${TRIM}" -eq "qc-trim" ]]
then
    echo -e  "[ngseasy]:Calling ngseasy_trimmomatic" 
    logger_ngseasy "[ngseasy]:Calling ngseasy_trimmomatic" ${HOME}/ngseasy_logs/ngseasy.${POJECT_ID}.${USER}.$(date +"%d%m%y")

    /bin/bash ngseasy_trimmomatic -c ${config_tsv} -d ${project_directory}

else
    echo -e  "[ngseasy]:Skipping qc-trimming" 
    logger_ngseasy "[ngseasy]:Reading [${config_tsv}] " ${HOME}/ngseasy_logs/ngseasy.${POJECT_ID}.${USER}.$(date +"%d%m%y")
fi

##-------------------------------------------------------------------------##
## alignment : includes addition of read groups at alignment stage 
## and then duplicate marking with samblaster and indexing and sorting with sambamba
## added SNAP aligner
## realignment includes bamleftalign
/bin/bash ngseasy_alignment -c ${config_tsv} -d ${project_directory}


##-------------------------------------------------------------------------##
## NGS Processing : Indel realignment and base quality score reclibration using GATK or BamUtil/ogap
if [[ "${GATK}" -eq 1 ]] && [[ "${REALN}" -eq 1 ]] && [[ "${BSQR}" -eq 1 ]]
then
    echo -e  "[ngseasy]:running gatk indel realignment and base quality score recalibration"

    echo -e  "[ngseasy]:Calling ngseasy_indel_realn" 
    
    /bin/bash ngseasy_indel_realn -c ${config_tsv} -d ${project_directory}
  
    echo -e  "[ngseasy]:Calling ngseasy_base_recal"
    
   /bin/bash  ngseasy_base_recal -c ${config_tsv} -d ${project_directory}
    
elif [[ "${GATK}" -eq 1 ]] && [[ "${REALN}" -eq 0 ]] && [[ "${BSQR}" -eq 1 ]]
then

  /bin/bash ngseasy_base_recal -c ${config_tsv} -d ${project_directory}

elif [[ "${GATK}" -eq 0 ]] && [[ "${REALN}" -eq 1 ]] && [[ "${BSQR}" -eq 1 ]]
then

  #ngseasy_ogap_realn -c ${config_tsv} -d ${project_directory}
  /bin/bash ngseasy_bamutil_base_recal -c ${config_tsv} -d ${project_directory}

elif [[ "${GATK}" -eq 0 ]] && [[ "${REALN}" -eq 0 ]] && [[ "${BSQR}" -eq 1 ]]
then

  /bin/bash ngseasy_bamutil_base_recal -c ${config_tsv} -d ${project_directory}
  
fi

##-------------------------------------------------------------------------##
## Alignment statistics
/bin/bash ngseasy_alignment_qc -c ${config_tsv} -d ${project_directory}

##-------------------------------------------------------------------------##
## SNP/INDEL calling
/bin/bash ngseasy_variant_calling -c ${config_tsv} -d ${project_directory}
 
/bin/bash ngseasy_variant_calling_fast_ensemble -c ${config_tsv} -d ${project_directory}

##-------------------------------------------------------------------------##
## CNV Calling

##-------------------------------------------------------------------------##
## Annotation

##-------------------------------------------------------------------------##
## NGS Report


done < ${config_tsv}